  <!doctype html>
  <html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Sunway Resort Hotel — Payment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
      :root{
        --main:#FFFDD0;
        --secondary:#C4A484;
        --accent:#AA7F2E;
        --black:#000000;
        --danger:#b00020;
      }
      *{box-sizing:border-box}
      body{margin:0;background:var(--main);color:#1a1a1a;font:16px/1.6 'Poppins',sans-serif}
      header{background:var(--black);color:var(--main);text-align:center;padding:28px 10px 36px;box-shadow:0 6px 24px rgba(0,0,0,.28)}
      header h1{margin:0;font-family:'Playfair Display',serif;color:var(--accent);letter-spacing:.5px;font-size:34px}
      header p{margin:6px 0 0;opacity:.9}
      .wrap{max-width:520px;margin:48px auto;padding:20px}
      .card{background:#fffdf6;border:1px solid var(--secondary);border-radius:16px;padding:22px 22px 20px;box-shadow:0 8px 24px rgba(0,0,0,.12)}
      h2{margin:0 0 10px;font-family:'Playfair Display',serif;color:var(--accent);font-size:22px}
      p.sub{margin:0 0 16px;color:#444}
      label{display:block;margin:12px 0 6px;color:#111;font-weight:500}
      input,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--secondary);background:#fff;color:#111;font-size:16px;font-family:'Poppins',sans-serif}
      input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(170,127,46,.25)}
      .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
      .brand{margin-top:6px;font-size:13px;color:#333}
      .err{color:var(--danger);font-size:13px;margin-top:6px;min-height:1.2em}
      .cta{margin-top:18px;background:var(--black);border:none;color:var(--main);font-weight:700;cursor:pointer;transition:opacity .2s}
      .cta:hover{opacity:.9}
      .cta:disabled{opacity:.5;cursor:not-allowed}
      .foot{margin-top:12px;text-align:center;color:#555;font-size:12px}
      .pill{display:inline-block;margin-right:8px;margin-bottom:8px;padding:6px 10px;border:1px solid var(--secondary);border-radius:999px;font-size:12px;color:#333;background:#fffdf8}
      .readonly{background:#fff8e0; cursor:not-allowed; color:#111}
    </style>
  </head>
  <body>
    <header>
      <h1>Sunway Resort Hotel</h1>
      <p>Secure Card Payment</p>
    </header>

    <div class="wrap">
      <div class="card">
        <h2>Payment</h2>
        <p class="sub">The total is pre-filled from your booking. We only keep card brand + last4.</p>

        <div id="summary" style="margin-bottom:8px;"></div>

        <label for="amount">Amount (<span id="ccyLbl">MYR</span>)</label>
        <input id="amount" class="readonly" inputmode="decimal" readonly aria-readonly="true" title="Amount is set by your booking">

        <label for="card">Card number</label>
        <input id="card" inputmode="numeric" autocomplete="cc-number" placeholder="XXXX XXXX XXXX XXXX" maxlength="19"/>
        <div class="brand" id="brand">Brand: —</div>

        <div class="row">
          <div>
            <label for="exp">Expiry (MM/YY)</label>
            <input id="exp" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" maxlength="5"/>
          </div>
          <div>
            <label for="name">Name on card</label>
            <input id="name" placeholder="Full name (2–40 chars)" maxlength="40"/>
          </div>
        </div>

        <div class="err" id="err"></div>
        <button class="cta" id="pay" disabled>Pay now</button>
        <div class="foot">We’ll redirect you to your receipt & QR after this step.</div>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://aleigsfkupsuxigeimqh.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFsZWlnc2ZrdXBzdXhpZ2VpbXFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1MTAxNzQsImV4cCI6MjA3NTA4NjE3NH0.yri1Ij57G7557vX3Xi7cNkvFQ-Mr-QuzRpBnSNFUaXA";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const qs = new URLSearchParams(location.search);
      const reservationId = qs.get("reservation_id") || "";
      const roomType = qs.get("room_type") || "";
      const currency = qs.get("currency") || "MYR";
      const startAmount = qs.get("amount");

      document.getElementById("ccyLbl").textContent = currency;
      const summary = document.getElementById("summary");
      summary.innerHTML = [
        reservationId ? `<span class="pill">Reservation: ${reservationId.slice(0,8)}…</span>` : "",
        roomType ? `<span class="pill">Room: ${roomType.replace(/-/g," ")}</span>` : ""
      ].join(" ");

      const byId = id => document.getElementById(id);
      const cardEl = byId("card"),
            expEl = byId("exp"),
            nameEl = byId("name"),
            amtEl = byId("amount"),
            brandEl = byId("brand"),
            errEl = byId("err"),
            payBtn = byId("pay");

      if (startAmount && !isNaN(parseFloat(startAmount)) && parseFloat(startAmount) > 0) {
        amtEl.value = String(parseFloat(startAmount).toFixed(2));
      } else {
        amtEl.value = "";
        errEl.textContent = "Missing or invalid amount. Please return to room selection.";
      }

      // Validation
      const cleanDigits = s => (s || "").replace(/\D+/g,"");
      const group4 = s => s.replace(/(\d{4})(?=\d)/g,"$1 ");
      const luhn = digits => {let sum=0,alt=false;for(let i=digits.length-1;i>=0;i--){let n=+digits[i];if(alt){n*=2;if(n>9)n-=9}sum+=n;alt=!alt}return sum%10===0;};
      const brandOf = d => {
        if(/^4\d{12}(\d{3})?$/.test(d))return"visa";
        if(/^(5[1-5]\d{14})$/.test(d) || /^2(2[2-9]\d{12}|[3-6]\d{13}|7(0\d{12}|1\d{12}|20\d{12}))$/.test(d))return"mastercard";
        return null;
      };

      cardEl.addEventListener("input", () => {
        const digits = cleanDigits(cardEl.value).slice(0,16);
        cardEl.value = group4(digits);
        const b = brandOf(digits);
        brandEl.textContent = "Brand: " + (b ? b.toUpperCase() : "—");
        validate();
      });

      expEl.addEventListener("input", () => {
        let v = cleanDigits(expEl.value).slice(0,4);
        if(v.length>=3) v = v.slice(0,2)+"/"+v.slice(2);
        expEl.value = v;
        validate();
      });

      nameEl.addEventListener("input", validate);

      function validate(){
        errEl.textContent="";
        const amount=parseFloat(amtEl.value);
        if (!(amount>0)) return setBad("Missing amount. Please return to room selection.");

        const digits=cleanDigits(cardEl.value), b=brandOf(digits);
        if(!b)return setBad("Enter a valid Visa/Mastercard.");
        if(digits.length!==16)return setBad("Card must be 16 digits.");
        if(!luhn(digits))return setBad("Card number is invalid.");

        const exp=expEl.value;if(!/^\d{2}\/\d{2}$/.test(exp))return setBad("Expiry must be MM/YY.");
        const [mm,yy]=exp.split("/").map(n=>+n);
        const now=new Date(), currYY=now.getFullYear()%100, currMM=now.getMonth()+1, maxYY=(now.getFullYear()+10)%100;
        if(yy<currYY||(yy===currYY&&mm<currMM))return setBad("Card is expired.");
        if(yy>maxYY)return setBad("Expiry year is too far.");

        const name=nameEl.value.trim();
        if(!/^[A-Za-z' -]{2,40}$/.test(name))return setBad("Name: 2–40 letters, spaces, - or '.");

        payBtn.disabled=false;
        return true;

        function setBad(m){errEl.textContent=m;payBtn.disabled=true;return false;}
      }

      function uuid(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,c=>(c^crypto.getRandomValues(new Uint8Array(1))[0]&15>>c/4).toString(16));}

        byId("pay").addEventListener("click", async ()=>{
        if(!validate())return;
        const digits=cleanDigits(cardEl.value), b=brandOf(digits);

      const db_payload = {
        day: qs.get('day'),
        nights: parseInt(qs.get('nights')),
        room_type: qs.get('room_type'),
        pax_total: parseInt(qs.get('totalPax')),
        status: 'paid',
        amount: parseFloat(qs.get('amount')),
        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
        paid_at: new Date().toISOString(),
        reservation_id: reservationId
      };

      console.log("db_payload:", db_payload);
      try {
        const { data, error } = await supabase.from('bookings').insert([db_payload]);
        if (error) {
          console.error("Insert error:", error);
          errEl.textContent = "Failed to record booking in Supabase.";
          return;
        }
        console.log("Inserted:", data);
      } catch (e) {
        console.error("Unexpected error:", e);
        errEl.textContent = "Unexpected error inserting booking.";
      }

        // Redirect to receipt
        const payload = {
          reservation_id: reservationId || "",
          room_type: roomType || "",
          token: "tok_" + uuid(),
          brand: b,
          last4: digits.slice(-4),
          amount: amtEl.value,
          currency: currency,
          name: nameEl.value.trim()
        };
        location.href = "receipt.html?" + new URLSearchParams(payload).toString();
      });
    </script>
  </body>
  </html>
